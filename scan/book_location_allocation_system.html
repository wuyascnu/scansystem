<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>书籍位置分配系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h3 class="text-center">书籍位置分配系统</h3>
        <div class="mt-4">
            <form id="uploadForm">
                <input type="file" id="fileInput" name="file" accept=".xlsx,.xls" class="form-control mb-3" required>
                <button type="submit" class="btn btn-primary btn-block">上传并分配</button>
            </form>
        </div>

        <!-- 进度条 -->
        <div class="progress mt-4" style="height: 20px; display: none;" id="progressBarContainer">
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar" style="width: 0%;">0%</div>
        </div>

        <div id="resultTable" class="mt-4" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
                <h5>分配结果</h5>
                <div>
                    <button class="btn btn-success btn-sm" id="exportBtn" style="display: none;">导出结果</button>
                    <button class="btn btn-secondary btn-sm" id="clearBtn" style="display: none;">清除此次上传</button>
                </div>
            </div>
            <table class="table table-bordered mt-3">
                <thead>
                    <tr>
                        <th>条码号</th>
                        <th>层架号编码</th>
                        <th>层架名</th>
                    </tr>
                </thead>
                <tbody id="resultBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            $('#uploadForm').on('submit', function (e) {
                e.preventDefault();

                // 显示进度条
                $('#progressBarContainer').show();
                $('#progressBar').css('width', '0%').text('0%');

                let formData = new FormData();
                formData.append('file', $('#fileInput')[0].files[0]);

                $.ajax({
                    url: 'https://tiezheng.natapp4.cc/api/books/upload',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    xhr: function () {
                        let xhr = new XMLHttpRequest();
                        xhr.upload.addEventListener('progress', function (e) {
                            if (e.lengthComputable) {
                                let percentComplete = Math.round((e.loaded / e.total) * 100);
                                $('#progressBar').css('width', percentComplete + '%').text(percentComplete + '%');
                            }
                        });
                        return xhr;
                    },
                    success: function (response) {
                        // 处理成功的分配结果
                        $('#resultBody').empty();
                        response.forEach(function (book) {
                            $('#resultBody').append(`
                                <tr>
                                    <td>${book['条码号']}</td>
                                    <td>${book['层架号编码']}</td>
                                    <td>${book['层架名']}</td>
                                </tr>
                            `);
                        });

                        // 显示结果表格和操作按钮
                        $('#resultTable').show();
                        $('#exportBtn').show();
                        $('#clearBtn').show();
                    },
                    error: function (xhr) {
                        // 显示详细的错误信息
                        let errorMessage = xhr.responseText ? xhr.responseText : '分配失败，请检查文件格式或后端服务';
                        alert('错误信息：' + errorMessage);
                    },
                    complete: function () {
                        // 隐藏进度条
                        $('#progressBarContainer').hide();
                    }
                });
            });

            // 导出结果
            $('#exportBtn').click(function () {
                // 获取当前时间戳
                const timestamp = new Date().toISOString().replace(/[-:T]/g, '').split('.')[0];

                // 使用 SheetJS 导出表格
                let wb = XLSX.utils.table_to_book(document.querySelector('table'), {
                    sheet: "分配结果",
                    raw: true, // 保留原始数据
                });

                // 避免条码号变成数字
                const ws = wb.Sheets["分配结果"];
                for (let cell in ws) {
                    if (cell.startsWith('A') && ws[cell].t === 'n') { // A 列且是数字
                        ws[cell].t = 's'; // 转为字符串
                        ws[cell].v = ws[cell].v.toString().padStart(7, '0'); // 补充前导零
                    }
                }

                XLSX.writeFile(wb, `Book_Allocation_Result_${timestamp}.xlsx`);
            });

            // 清除上传
            $('#clearBtn').click(function () {
                $('#resultBody').empty();
                $('#resultTable').hide();
                $('#exportBtn').hide();
                $('#clearBtn').hide();
                $('#fileInput').val('');
            });
        });
    </script>
</body>
</html>
