<!DOCTYPE html>
<html lang="zh">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>图书书架层架位置分配维护系统</title>
   <!-- 引入 Bootstrap 和 Bootstrap Table 样式 -->
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.20.2/dist/bootstrap-table.min.css">
   <!-- Ensure FileSaver and xlsx scripts are loaded for tableExport -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
   <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
   <style>
       body {
           font-family: 'Arial', sans-serif;
       }
       .container {
           max-width: 100%;
           padding: 15px;
       }
       .table-container {
           margin-top: 20px;
           max-height: calc(100vh - 200px);
           overflow-x: auto;
           overflow-y: auto;
       }
       thead th {
           position: sticky;
           top: 0;
           background-color: #fff;
           z-index: 10;
       }
       table {
           font-size: 14px;
       }
   </style>
</head>
<body>
    <div class="container mt-4">
        <div class="text-center d-flex align-items-center justify-content-center">
            <img src="./img/logo.png" alt="Logo" style="height: 1.5em; margin-right: 10px;">
            <h3>图书书架层架位置分配维护系统</h3>
        </div>

        <!-- Tab 导航栏 -->
        <ul class="nav nav-tabs" id="tabMenu" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="classification-tab" data-toggle="tab" href="#classification" role="tab" aria-controls="classification" aria-selected="true">图书书架信息</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="shelf-tab" data-toggle="tab" href="#shelf" role="tab" aria-controls="shelf" aria-selected="false">图书层架信息</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="book-allocation-tab" data-toggle="tab" href="#book-allocation" role="tab" aria-controls="book-allocation" aria-selected="false">图书位置分配信息</a>
            </li>
        </ul>

        <!-- Tab 内容 -->
        <div class="tab-content" id="tabContent">
            <!-- 图书分类层架信息维护 -->
            <div class="tab-pane fade show active" id="classification" role="tabpanel" aria-labelledby="classification-tab">
                <div class="mb-3 text-center">
                    <button id="addBtn" class="btn btn-success">新增</button>
                    <button id="editBtn" class="btn btn-primary">编辑</button>
                    <button id="deleteBtn" class="btn btn-danger">删除</button>
                    <button id="exportBtn" class="btn btn-info">导出</button>
                    <button id="importBtn" class="btn btn-warning">导入</button>
                    <a href="template.xlsx" download="导入模板.xlsx" class="btn btn-secondary">模板下载</a>
                    <button id="refreshClassificationBtn" class="btn btn-secondary">刷新</button>
                </div>
                <div class="table-container">
                    <table id="classificationTable" data-toggle="table" data-search="true" data-pagination="false" data-click-to-select="true" data-single-select="true" data-id-field="classificationId">
                        <thead>
                            <tr>
                                <th data-checkbox="true"></th>
                                <th data-field="classificationId">ID</th>
                                <th data-field="classificationName">分类名称</th>
                                <th data-field="classificationLetter">中图法分类字母</th>
                                <th data-field="classificationDescription">分类描述</th>
                                <th data-field="shelfNumber">书架号</th>
                                <th data-field="allocatedCapacity">目前分配书籍容量</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>

            <!-- 层架信息 -->
            <div class="tab-pane fade" id="shelf" role="tabpanel" aria-labelledby="shelf-tab">
                <div class="mb-3 text-center">
                    <button id="addShelfBtn" class="btn btn-success">新增</button>
                    <button id="editShelfBtn" class="btn btn-primary">编辑</button>
                    <button id="deleteShelfBtn" class="btn btn-danger">删除</button>
                    <button id="exportShelfBtn" class="btn btn-info">导出</button>
                    <button id="importShelfBtn" class="btn btn-warning">导入</button>
                    <button id="refreshShelfBtn" class="btn btn-secondary">刷新</button>
                </div>
                <div class="table-container">
                    <table id="shelfTable" data-toggle="table" data-search="true" data-pagination="true" data-click-to-select="true" data-id-field="id">
                        <thead>
                            <tr>
                                <th data-checkbox="true"></th>
                                <th data-field="id">序号</th>
                                <th data-field="shelfCode">层架号编码</th>
                                <th data-field="shelfName">层架名</th>
                                <th data-field="capacity">最大存放容量(单位：本)</th>
                                <th data-field="usedCapacity">已用容量(单位：本)</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>

            <!-- 图书位置分配信息 -->
            <div class="tab-pane fade" id="book-allocation" role="tabpanel" aria-labelledby="book-allocation-tab">
                <div class="mb-3 text-center">
                    <select id="allocationDateFilter" class="form-control" style="width: 200px; display: inline-block;">
                        <option value="">选择分配时间</option>
                    </select>
                    <button id="clearDateBtn" class="btn btn-danger">一键清除该分配时间的位置信息</button>
                    <button id="addBookAllocationBtn" class="btn btn-success">新增</button>
                    <button id="editBookAllocationBtn" class="btn btn-primary">编辑</button>
                    <button id="deleteBookAllocationBtn" class="btn btn-danger">删除</button>
                    <button id="refreshBookAllocationBtn" class="btn btn-secondary">刷新</button>
                </div>
                <div class="table-container">
                    <table id="bookAllocationTable" data-toggle="table" data-search="true" data-pagination="true" data-click-to-select="true" data-id-field="id">
                        <thead>
                            <tr>
                                <th data-checkbox="true"></th>
                                <th data-field="id">ID</th>
                                <th data-field="barcode">条码号</th>
                                <th data-field="shelfCode">层架号编码</th>
                                <th data-field="shelfName">层架名</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9999;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white;">
            加载中...
        </div>
    </div>

    <!-- 引入脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.20.2/dist/bootstrap-table.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin/tableExport.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
   
    <script>
        let apiUrl = '';  // 用于存储动态的 API 地址

// 加载配置文件
function loadConfig() {
    fetch('../config.json')  // 读取配置文件
        .then(response => response.json())  // 解析 JSON
        .then(config => {
            apiUrl = config.apiUrl;  // 获取 API 地址
            console.log('API URL:', apiUrl);  // 打印 API 地址
            initializeTables();  // 调用表格初始化函数
        })
        .catch(err => {
            console.error('配置加载失败:', err);
        });
}

// 初始化表格并更新 URL
function initializeTables() {
    // 使用 AJAX 方式直接加载数据
    $('#classificationTable').bootstrapTable('destroy').bootstrapTable({
        url: `${apiUrl}/api/library-classification`, // 动态设置数据源URL
		ajaxOptions: {                  // 自定义AJAX请求选项
        type: 'GET',                    // 请求类型（默认是GET）
        headers: {                      // 添加自定义请求头
            'ngrok-skip-browser-warning': '69420',
            'Content-Type': 'application/json',
        },
        success: function(data) {       // 请求成功的回调函数
            console.log('数据加载成功:', data);
        },
        error: function(err) {          // 请求失败的回调函数
            console.error('请求失败:', err);
        }
    },
        search: true,
        pagination: false,
        clickToSelect: true,
        singleSelect: true,
        idField: 'classificationId', // 设置 ID 字段
    });
    
    $('#shelfTable').bootstrapTable('destroy').bootstrapTable({
        url: `${apiUrl}/api/shelves`, // 动态设置数据源URL
	    ajaxOptions: {                  // 自定义AJAX请求选项
        type: 'GET',                    // 请求类型（默认是GET）
        headers: {                      // 添加自定义请求头
            'ngrok-skip-browser-warning': '69420',
            'Content-Type': 'application/json',
        },
        success: function(data) {       // 请求成功的回调函数
            console.log('数据加载成功:', data);
        },
        error: function(err) {          // 请求失败的回调函数
            console.error('请求失败:', err);
        }
    },
        search: true,
        pagination: true,
        clickToSelect: true,
        idField: 'id', // 设置 ID 字段
    });

    $('#bookAllocationTable').bootstrapTable('destroy').bootstrapTable({
        url: `${apiUrl}/api/books`, // 动态设置数据源URL
	    ajaxOptions: {                  // 自定义AJAX请求选项
        type: 'GET',                    // 请求类型（默认是GET）
        headers: {                      // 添加自定义请求头
            'ngrok-skip-browser-warning': '69420',
            'Content-Type': 'application/json',
        },
        success: function(data) {       // 请求成功的回调函数
            console.log('数据加载成功:', data);
        },
        error: function(err) {          // 请求失败的回调函数
            console.error('请求失败:', err);
        }
    },
        search: true,
        pagination: true,
        clickToSelect: true,
        idField: 'id', // 设置 ID 字段
    });
}

$(document).ready(function () {
    loadConfig();  // 页面加载时调用加载配置函数
});

    </script>
</body>
</html>
