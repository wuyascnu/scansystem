<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>书籍位置查询系统</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
        }
        #header {
            position: relative;
            height: 100px;
            background: url('./img/logo.png') no-repeat center top;
            background-size: 80px;
        }
        h3 {
            text-align: center;
            margin: 5px 0;
            font-size: 18px;
        }
        #controls {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        input, button {
            width: 90%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #scanResults {
            margin: 20px;
            font-size: 14px;
        }
        #scanResults h4 {
            margin: 10px 0;
        }
        #scanResults ul {
            list-style: none;
            padding: 0;
        }
        #scanResults li {
            margin: 5px 0;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        #scanResults li.success {
            background-color: #d4edda;
            color: #155724;
        }
        #scanResults li.error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div id="header"></div>
    <h3>书籍位置查询系统</h3>
    <div id="controls">
        <input type="text" id="barcodeInput" placeholder="输入条码或扫码" autofocus>
        <button id="startScanBtn">启动摄像头扫描</button>
        <button id="clearResultsBtn">清空结果</button>
        <button id="exportErrorsBtn">导出错误条码</button>
    </div>
    <div id="scanResults">
        <h4>查询结果</h4>
        <ul id="resultList"></ul>
    </div>

    <script>
        const input = document.getElementById('barcodeInput');
        const resultList = document.getElementById('resultList');
        const startScanBtn = document.getElementById('startScanBtn');
        const clearResultsBtn = document.getElementById('clearResultsBtn');
        const exportErrorsBtn = document.getElementById('exportErrorsBtn');
        const errorBarcodes = []; // 存储错误条码
        const scannedBarcodes = new Set(); // 防止重复查询

        // 清空结果
        clearResultsBtn.addEventListener('click', () => {
            resultList.innerHTML = '';
            errorBarcodes.length = 0;
            scannedBarcodes.clear();
        });

        // 导出错误条码
        exportErrorsBtn.addEventListener('click', () => {
            if (errorBarcodes.length === 0) {
                alert('没有错误条码可导出！');
                return;
            }
            const csvContent = "data:text/csv;charset=utf-8," + errorBarcodes.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', '错误条码.csv');
            document.body.appendChild(link);
            link.click();
        });

        // 显示结果
        function addScanResult(barcode, status, message) {
            const li = document.createElement('li');
            li.className = status === '成功' ? 'success' : 'error';
            li.textContent = `条码: ${barcode}, 状态: ${status}, 信息: ${message}`;
            resultList.appendChild(li);

            // 如果失败，记录错误条码
            if (status === '失败') {
                errorBarcodes.push(barcode);
            }

            // 语音播报
            speak(message);
        }

        // 查询条码
        function searchBook(barcode) {
            if (!barcode || scannedBarcodes.has(barcode)) return; // 跳过重复条码
            scannedBarcodes.add(barcode);

            fetch(`/api/${barcode}`)
                .then(response => {
                    if (!response.ok) throw new Error('查询失败');
                    return response.json();
                })
                .then(data => {
                    addScanResult(barcode, '成功', `位置: ${data.shelfName}`);
                })
                .catch(() => {
                    addScanResult(barcode, '失败', '未找到书籍信息');
                });
        }

        // 批量扫码
        input.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                const barcode = input.value.trim();
                searchBook(barcode);
                input.value = ''; // 清空输入框
            }
        });

        // 语音播报
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>