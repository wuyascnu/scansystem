<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>铁铮图书馆图书分类层架信息表</title>
    <!-- 引入 Bootstrap 和 Bootstrap Table 样式 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.20.2/dist/bootstrap-table.min.css">
    <style>
        /* 设置表格行高 */
        #table tbody tr {
            line-height: 1.5em; /* 调整行高 */
        }

        /* 设置表格容器高度，防止底部挨着浏览器 */
        .table-container {
            margin-bottom: 20px; /* 底部留出间距 */
            max-height: 600px; /* 最大高度 */
            overflow-y: auto; /* 超出部分滚动 */
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h3 class="text-center">铁铮图书馆图书分类层架信息表</h3>

        <!-- 工具栏 -->
        <div class="mb-3">
            <button id="addBtn" class="btn btn-success">新增</button>
            <button id="editBtn" class="btn btn-primary">编辑</button>
            <button id="deleteBtn" class="btn btn-danger">删除</button>
            <button id="exportBtn" class="btn btn-info">导出</button>
            <button id="importBtn" class="btn btn-warning">导入</button>
            <a href="template.xlsx" download="导入模板.xlsx" class="btn btn-secondary">模板下载</a>
        </div>

        <!-- 表格容器 -->
        <div class="table-container">
            <!-- 动态数据表格 -->
            <table id="table"
                   data-toggle="table"
                   data-url="https://tiezheng.natapp4.cc/api/library-classification"
                   data-search="true"
                   data-pagination="false"
                   data-click-to-select="true"
                   data-single-select="true"
                   data-id-field="classificationId">
                <thead>
                    <tr>
                        <th data-checkbox="true"></th>
                        <th data-field="classificationId">分类ID</th>
                        <th data-field="classificationName">分类名称</th>
                        <th data-field="classificationLetter">中图法分类字母</th>
                        <th data-field="classificationDescription">中图法分类名称</th>
                        <th data-field="shelfNumber">书架号</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>

    <!-- 引入脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.20.2/dist/bootstrap-table.min.js"></script>
    <!-- 引入 tableExport 插件 -->
    <script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin/tableExport.min.js"></script>
	<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script>
        $(document).ready(function () {
            // 初始化表格
            $('#table').bootstrapTable({
                onLoadSuccess: function (data) {
                    console.log('Table loaded successfully', data);
                },
                onLoadError: function (status, jqXHR) {
                    console.error('Failed to load table data:', status, jqXHR);
                }
            });

            // 导出功能
            $('#exportBtn').click(function () {
                $('#table').tableExport({
                    type: 'excel', // 导出为 Excel 文件
                    fileName: '图书分类层架信息表', // 文件名
                    exportDataType: 'all' // 导出所有数据
                });
            });

            // 导入功能
            $('#importBtn').click(function () {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx, .xls';
                input.onchange = function (e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);

                        // 字段名映射
                        const fieldMapping = {
                            "分类ID": "classificationId",
                            "分类名称": "classificationName",
                            "中图法分类字母": "classificationLetter",
                            "中图法分类名称": "classificationDescription",
                            "书架号": "shelfNumber"
                        };

                        // 转换字段名
                        const mappedData = jsonData.map(row => {
                            const mappedRow = {};
                            for (const key in row) {
                                if (fieldMapping[key]) {
                                    mappedRow[fieldMapping[key]] = row[key];
                                }
                            }
                            return mappedRow;
                        });

                        console.log("转换后的数据：", mappedData);

                        // 调用后端 API 批量保存导入数据
                        $.ajax({
                            url: 'https://tiezheng.natapp4.cc/api/library-classification',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(mappedData),
                            success: function (response) {
                                alert('导入成功！');
                                $('#table').bootstrapTable('refresh');
                            },
                            error: function (xhr, status, error) {
                                console.error('导入失败', error);
                                alert('导入失败，请检查数据格式！');
                            }
                        });
                    };
                    reader.readAsArrayBuffer(file);
                };
                input.click();
            });
        });
    </script>
</body>
</html>
