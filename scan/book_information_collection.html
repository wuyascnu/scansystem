<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>书籍信息采集</title>
    <script>
        function fetchBookInfo() {
            var isbn = document.getElementById("isbnInput").value;
            fetch(`https://lib.nuotu.net/api/catalogue/queryIsbn`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bookIsbn: isbn,
                    graspNetworkImg: true,
                    getGroupLibCatalogue: false
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.rtcode === '000') {
                    var book = data.data.z39list[0]; // 获取书籍信息
                    document.getElementById("bookTitle").innerText = "书名: " + book.bookName;
                    document.getElementById("bookPrice").innerText = "价格: " + book.bookPrice;
                    document.getElementById("bookPublisher").innerText = "出版社: " + book.publishingCompany;
                    document.getElementById("bookPublishTime").innerText = "出版时间: " + book.publishTime;
                    document.getElementById("bookPages").innerText = "页数: " + book.bookPages;
                    // 保存书籍信息到后端数据库
                    saveBookInfo(book);
                } else {
                    alert("未找到书籍信息");
                }
            })
            .catch(err => alert("查询失败"));
        }

        function saveBookInfo(book) {
            fetch('/api/saveBookInfo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    isbn: book.bookIsbn,
                    title: book.bookName,
                    price: book.bookPrice,
                    publisher: book.publishingCompany,
                    publishTime: book.publishTime,
                    pages: book.bookPages,
                    timestamp: new Date().toISOString() // 采集时间戳
                })
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
                document.getElementById("isbnInput").value = ""; // 清空输入框
                document.getElementById("isbnInput").focus(); // 聚焦输入框
            })
            .catch(err => alert("保存失败"));
        }

        function exportData() {
            fetch('/api/exportCollectedData', {
                method: 'GET',
            })
            .then(response => response.blob())
            .then(data => {
                // 将返回的文件保存为下载文件
                const url = window.URL.createObjectURL(data);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'collected_books_data.xlsx'; // 自定义文件名
                link.click();
            })
            .catch(err => alert("导出失败"));
        }
    </script>
</head>
<body>
    <h1>书籍信息采集</h1>
    <input type="text" id="isbnInput" placeholder="请输入ISBN">
    <button onclick="fetchBookInfo()">查询并保存</button>
    <button onclick="exportData()">导出今日采集数据</button>

    <div>
        <h2 id="bookTitle"></h2>
        <p id="bookPrice"></p>
        <p id="bookPublisher"></p>
        <p id="bookPublishTime"></p>
        <p id="bookPages"></p>
    </div>
</body>
</html>
